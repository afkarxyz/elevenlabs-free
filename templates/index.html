<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Free</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f3f4f6;
            color: #111827;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .input {
            border: 1px solid #d1d5db;
        }
        .input:focus {
            border-color: #6b7280;
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }
        .button {
            background-color: #111827;
            color: #ffffff;
            transition: all 0.2s;
        }
        .button:hover {
            background-color: #374151;
        }
        .tab {
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #111827;
        }
        .circle-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .usage-warning {
            background-color: #F59E0B;
        }
        .usage-danger {
            background-color: #DC3545;
        }
        .text-red-400 {
            color: #DC3545;
        }
        #voiceSelect option {
            white-space: normal;
            word-wrap: break-word;
            max-width: 100%;
            padding: 5px;
        }
        @media (min-width: 640px) {
            .mobile-info {
                display: none;
            }
        }
        @media (max-width: 639px) {
            .desktop-info {
                display: none;
            }
        }
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 300px;
            width: 90%;
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            color: #111827;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .custom-alert.show {
            opacity: 1;
        }
        .custom-alert-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .custom-alert-button {
            margin: 0 5px;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            flex: 1;
            max-width: 120px;
        }
        .custom-alert-confirm {
            background-color: #DC2626;
            color: #ffffff;
        }
        .custom-alert-confirm:hover {
            background-color: #B91C1C;
        }
        .custom-alert-cancel {
            background-color: #1F2937;
            color: #ffffff;
        }
        .custom-alert-cancel:hover {
            background-color: #111827;
        }
        .custom-alert-message {
            margin-bottom: 15px;
        }
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        button {
            -webkit-tap-highlight-color: transparent;
        }
        button:focus {
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-white border-b border-gray-200 p-4">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                <img src="{{ url_for('static', filename='images/favicon.svg') }}" alt="ElevenLabs Logo" class="w-8 h-8 mr-2">
                <a href="https://github.com/afkarxyz/elevenlabs-free" target="_blank" class="hover:text-gray-700">
                    ElevenLabs
                </a>
                <span class="text-sm font-normal text-gray-500 ml-1 mt-1">Free</span>
            </h1>
        </div>
    </header>

    <nav class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4">
            <div class="flex space-x-4">
                <button class="tab active py-4 px-2 text-sm font-medium" data-tab="dashboard">Dashboard</button>
                <button class="tab py-4 px-2 text-sm font-medium" data-tab="history">History</button>
                <button class="tab py-4 px-2 text-sm font-medium" data-tab="settings">Settings</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto py-8 px-4">
        <div class="max-w-3xl mx-auto">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="card rounded-lg overflow-hidden mb-4">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Usage <span id="usagePercentage" class="text-sm font-normal">(0%)</span></h2>
                        <div id="apiKeyNavigation" class="flex items-center space-x-2">
                            <button id="prevApiKey" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-left"></i></button>
                            <div class="flex items-center">
                                <input type="text" id="currentApiKeyIndex" class="w-10 text-center px-1" />
                                <span class="mx-1">/</span>
                                <span id="totalApiKeys" class="w-10 text-center"></span>
                            </div>
                            <button id="nextApiKey" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-clock-rotate-left mr-2 text-gray-600"></i>
                                <span id="resetDate" class="text-sm text-gray-600"></span>
                            </div>
                            <div class="flex items-center">
                                <span id="characterCount" class="text-sm text-gray-600 mr-2">0 / 0</span>
                                <i class="fas fa-coins text-yellow-500"></i>
                            </div>
                        </div>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                                <div id="usageBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-black" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card rounded-lg overflow-hidden mb-4">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Text to Speech</h2>
                    </div>
                    <div class="p-4">
                        <form id="ttsForm">
                            <div class="mb-4 relative">
                                <label for="inputText" class="block text-sm font-medium text-gray-700 mb-2">Input Your Text:</label>
                                <textarea id="inputText" class="input w-full px-3 py-2 rounded" rows="4" required placeholder="Type or paste your text here..."></textarea>
                                <div class="text-sm text-gray-500 mt-1 flex justify-between items-center">
                                    <span>Characters: <span id="charCount">0 / 0</span></span>
                                    <div>
                                        <button type="button" id="pasteButton" class="text-gray-600 hover:text-gray-900">
                                            <i class="fas fa-clipboard"></i>
                                        </button>
                                        <button type="button" id="clearButton" class="text-gray-600 hover:text-gray-900 ml-2">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="modelSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Model:</label>
                                <select id="modelSelect" class="input w-full px-3 py-2 rounded">
                                    <option value="eleven_multilingual_v2">Eleven Multilingual v2</option>
                                    <option value="eleven_flash_v2_5">Eleven Flash v2.5</option>
                                    <option value="eleven_turbo_v2_5">Eleven Turbo v2.5</option>
                                    <option value="eleven_turbo_v2">Eleven Turbo v2</option>
                                    <option value="eleven_flash_v2">Eleven Flash v2</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="voiceSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Voice:</label>
                                <select id="voiceSelect" class="input w-full px-3 py-2 rounded">
                                    <!-- Voice options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button type="submit" class="button px-4 py-2 rounded">
                                    <i class="fas fa-volume mr-2"></i> Generate
                                </button>
                                <div id="loading" class="hidden text-gray-600">
                                    <i class="fad fa-spinner-third fa-spin mr-2"></i> Processing...
                                </div>
                            </div>
                        </form>
                        
                        <div id="audioContainer" class="mt-6 hidden">
                            <audio controls class="w-full mb-4" id="audioPlayer">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="flex justify-center">
                                <button id="downloadButton" class="button px-4 py-2 rounded hidden">
                                    <i class="fas fa-arrow-down-to-arc mr-2"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content hidden">
                <div id="historyContent" class="card rounded-lg overflow-hidden mb-4">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center">
                            <button id="clearAllHistory" class="mr-2 text-gray-600 hover:text-gray-900 hidden">
                                <i class="fas fa-trash"></i>
                            </button>
                            <h2 class="text-lg font-semibold text-gray-900">History <span id="historyCount" class="text-sm font-normal"></span></h2>
                        </div>
                        <div id="historyNavigation" class="flex items-center space-x-2">
                            <button id="prevHistory" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-left"></i></button>
                            <div class="flex items-center">
                                <input type="text" id="currentHistoryIndex" class="w-10 text-center px-1" />
                            </div>
                            <button id="nextHistory" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="historyItem" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span id="historyTimestamp" class="text-sm text-gray-600"></span>
                                <span id="historyCharCount" class="text-sm text-gray-600"></span>
                            </div>
                            <div class="mb-4">
                                <p id="historyText" class="mb-2 text-gray-700 whitespace-pre-wrap"></p>
                                <button id="toggleFullText" class="text-sm text-blue-600 hover:text-blue-800">Show More</button>
                            </div>
                            <div class="mb-4">
                                <audio controls class="w-full mb-2" id="historyAudio">
                                    Your browser does not support the audio element.
                                </audio>
                                <span id="historyAudioSize" class="text-sm text-gray-600"></span>
                            </div>
                            <div class="flex justify-center space-x-2">
                                <button id="copyTextButton" class="button circle-button">
                                    <i class="fas fa-clone"></i>
                                </button>
                                <button id="reuseTextButton" class="button circle-button">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button id="downloadHistoryAudio" class="button circle-button">
                                    <i class="fas fa-arrow-down-to-arc"></i>
                                </button>
                                <button id="deleteHistoryButton" class="button circle-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="noHistoryMessage" class="text-center text-gray-500 py-8 hidden">
                    <p class="text-lg">No history yet.</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                <div class="card rounded-lg overflow-hidden mb-4">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center">
                            <button id="clearApiKey" class="mr-2 text-gray-600 hover:text-gray-900">
                                <i class="fas fa-trash"></i>
                            </button>
                            <h2 class="text-lg font-semibold text-gray-800"><span id="apiKeyLabel">API Key</span> <span id="apiKeyCount" class="text-sm font-normal"></span></h2>
                        </div>
                    </div>
                    <div class="p-4">
                        <form id="apiKeyForm">
                            <div class="mb-4">
                                <label for="apiKey" class="block text-sm font-medium text-gray-600 mb-2 flex items-center">
                                    <span class="flex-grow">ElevenLabs API Key:</span>
                                    <button type="button" class="text-gray-600 hover:text-gray-900 ml-2" id="toggleApiKey">
                                        <i class="fas fa-eye-slash"></i>
                                    </button>
                                </label>
                                <div class="relative">
                                    <input type="password" id="apiKey" class="input w-full px-3 py-2 rounded" placeholder="Enter your ElevenLabs API key">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <button type="button" id="importApiKey" class="button px-4 py-2 rounded">
                                    <i class="fas fa-key mr-2"></i> Import
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="py-2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">API Key File Format</h3>
                        <p class="text-sm text-gray-600 mb-2">To use multiple API keys, create a .txt file with one API key per line. For example:</p>
                        <div class="bg-gray-200 rounded text-sm text-gray-800 inline-block">
                          <div class="px-2 py-1">
                            <div>sk_13b46a...</div>
                            <div>sk_1ab364...</div>
                            <div>sk_3b46a1...</div>
                          </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Save the file with a .txt extension and use the "Import" button to upload it.</p>
                    </div>
                </div>
            </div>

            <div id="customAlert" class="custom-alert hidden"></div>
            <div id="customAlertOverlay" class="custom-alert-overlay"></div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');
                });
            });

            let historyItems = [];
            let currentHistoryIndex = -1;

            let db;
            const dbName = 'TtsHistoryDB';
            const dbVersion = 1;
            const storeName = 'history';

            let apiKeys = [];
            let currentApiKeyIndex = 0;

            function initializeApp() {
                apiKeys = JSON.parse(localStorage.getItem('elevenLabsApiKeys') || '[]');
                currentApiKeyIndex = parseInt(localStorage.getItem('currentApiKeyIndex') || '0');
                
                updateApiKeyDisplay();
                updateApiKeyNavigation();

                const savedModel = localStorage.getItem('elevenLabsSelectedModel');
                if (savedModel) {
                    document.getElementById('modelSelect').value = savedModel;
                }

                const inputText = document.getElementById('inputText');
                const charCount = document.getElementById('charCount');

                inputText.addEventListener('input', updateCharCount);

                document.getElementById('pasteButton').addEventListener('click', function() {
                    navigator.clipboard.readText().then(function(clipText) {
                        inputText.value = clipText;
                        updateCharCount();
                    });
                });

                document.getElementById('clearButton').addEventListener('click', function() {
                    inputText.value = '';
                    updateCharCount();
                });
            }

            const request = indexedDB.open(dbName, dbVersion);

            request.onerror = function(event) {
                console.error("IndexedDB error:", event.target.error);
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                loadHistoryFromDB();
            };

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                const objectStore = db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("timestamp", "timestamp", { unique: false });
            };

            function updateCharCount() {
                const inputText = document.getElementById('inputText');
                const charCount = document.getElementById('charCount');
                const inputLength = inputText.value.length;
                const [usedCredit, totalCredit] = document.getElementById('characterCount').textContent.split('/').map(s => parseInt(s.trim().replace(/,/g, '')));
                const remainingCredit = totalCredit - usedCredit;
                
                const inputLengthSpan = document.createElement('span');
                inputLengthSpan.textContent = formatNumber(inputLength);
                
                if (inputLength > remainingCredit) {
                    inputLengthSpan.classList.add('text-red-400');
                }
                
                charCount.innerHTML = '';
                charCount.appendChild(inputLengthSpan);
                charCount.appendChild(document.createTextNode(` / ${formatNumber(remainingCredit)}`));
            }

            function fetchVoices() {
                const apiKey = apiKeys[currentApiKeyIndex] || localStorage.getItem('elevenLabsApiKey');
                if (!apiKey) {
                    console.error('API key not found');
                    return;
                }

                fetch('/get-voices', {
                    headers: {
                        'X-API-KEY': apiKey
                    }
                })
                .then(response => response.json())
                .then(data => {
                    populateVoiceSelect(data);
                })
                .catch(error => {
                    console.error('Error fetching voices:', error);
                });
            }

            function fetchUsageInfo() {
                const apiKey = apiKeys[currentApiKeyIndex] || localStorage.getItem('elevenLabsApiKey');
                if (!apiKey) {
                    updateUsageInfo(0, 0, 0);
                    return;
                }

                fetch('/get-usage-info', {
                    headers: {
                        'X-API-KEY': apiKey
                    }
                })
                .then(response => response.json())
                .then(data => {
                    updateUsageInfo(data.character_count, data.character_limit, data.next_character_count_reset_unix);
                })
                .catch(error => {
                    console.error('Error fetching usage info:', error);
                    updateUsageInfo(0, 0, 0);
                });
            }

            initializeApp();

            fetchVoices();
            fetchUsageInfo();

            function downloadAudio(audioBlob, filename = 'audio.mp3') {
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            document.getElementById('toggleApiKey').addEventListener('click', function() {
                const apiKeyInput = document.getElementById('apiKey');
                const eyeIcon = this.querySelector('i');
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    eyeIcon.classList.remove('fa-eye-slash');
                    eyeIcon.classList.add('fa-eye');
                } else {
                    apiKeyInput.type = 'password';
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                }
            });

            document.getElementById('clearApiKey').addEventListener('click', function() {
                if (apiKeys.length > 1) {
                    showCustomConfirm("Are you sure you want to clear all API Keys?", function() {
                        apiKeys = [];
                        localStorage.removeItem('elevenLabsApiKeys');
                        localStorage.removeItem('currentApiKeyIndex');
                        currentApiKeyIndex = 0;
                        updateApiKeyDisplay();
                        updateApiKeyNavigation();
                        clearUsageInfo();
                        showCustomAlert('All API Keys have been cleared.', 'info');
                    });
                } else if (apiKeys.length === 1) {
                    showCustomConfirm("Are you sure you want to clear the API Key?", function() {
                        apiKeys = [];
                        localStorage.removeItem('elevenLabsApiKeys');
                        localStorage.removeItem('currentApiKeyIndex');
                        currentApiKeyIndex = 0;
                        updateApiKeyDisplay();
                        updateApiKeyNavigation();
                        clearUsageInfo();
                        showCustomAlert('API Key has been cleared.', 'info');
                    });
                }
            });

            document.getElementById('importApiKey').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result.trim();
                            const newKeys = content.split('\n')
                                .map(key => key.trim())
                                .filter(key => key.startsWith('sk_'));
                            
                            if (newKeys.length > 0) {
                                apiKeys = [];
                                localStorage.removeItem('elevenLabsApiKey');
                                
                                apiKeys = [...new Set(newKeys)];
                                localStorage.setItem('elevenLabsApiKeys', JSON.stringify(apiKeys));
                                
                                currentApiKeyIndex = 0;
                                localStorage.setItem('currentApiKeyIndex', currentApiKeyIndex);
                                
                                updateApiKeyDisplay();
                                updateApiKeyNavigation();
                                fetchVoices();
                                fetchUsageInfo();
                                showCustomAlert(`${newKeys.length} API Key(s) imported successfully!`, 'success');
                            } else {
                                showCustomAlert('No valid API Keys found in the file. Keys should start with "sk_".', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });

            function updateApiKeyDisplay() {
                const apiKeyInput = document.getElementById('apiKey');
                const apiKeyCount = document.getElementById('apiKeyCount');
                const apiKeyLabel = document.getElementById('apiKeyLabel');
                
                if (apiKeys.length === 0) {
                    apiKeyInput.value = '';
                    apiKeyInput.disabled = false;
                    apiKeyInput.placeholder = 'Enter your ElevenLabs API key';
                    apiKeyCount.textContent = '';
                    apiKeyLabel.textContent = 'API Key';
                } else if (apiKeys.length === 1) {
                    apiKeyInput.value = apiKeys[0];
                    apiKeyInput.disabled = false;
                    apiKeyInput.placeholder = 'Enter your ElevenLabs API key';
                    apiKeyCount.textContent = '';
                    apiKeyLabel.textContent = 'API Key';
                } else {
                    apiKeyInput.value = '';
                    apiKeyInput.disabled = true;
                    apiKeyInput.placeholder = 'Currently using multiple API keys';
                    apiKeyCount.textContent = `(${apiKeys.length})`;
                    apiKeyLabel.textContent = 'API Keys';
                }
            }

            function updateApiKeyNavigation() {
                const apiKeyNavigation = document.getElementById('apiKeyNavigation');
                const currentApiKeyIndexInput = document.getElementById('currentApiKeyIndex');
                const totalApiKeys = document.getElementById('totalApiKeys');
                const prevApiKey = document.getElementById('prevApiKey');
                const nextApiKey = document.getElementById('nextApiKey');

                if (apiKeys.length > 1) {
                    apiKeyNavigation.classList.remove('hidden');
                    currentApiKeyIndexInput.value = currentApiKeyIndex + 1;
                    totalApiKeys.textContent = apiKeys.length;
                    prevApiKey.disabled = currentApiKeyIndex === 0;
                    nextApiKey.disabled = currentApiKeyIndex === apiKeys.length - 1;
                } else {
                    apiKeyNavigation.classList.add('hidden');
                }
            }

            document.getElementById('apiKey').addEventListener('input', function() {
                if (apiKeys.length <= 1) {
                    apiKeys[0] = this.value;
                    localStorage.setItem('elevenLabsApiKeys', JSON.stringify(apiKeys));
                    fetchVoices();
                    fetchUsageInfo();
                }
            });

            function formatNumber(number) {
                return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            function formatFileSize(bytes) {
                if (bytes < 1024 * 1024) {
                    return (bytes / 1024).toFixed(2) + ' KB';
                } else {
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                }
            }

            function updateUsageInfo(characterCount, characterLimit, nextReset) {
                const usageBar = document.getElementById('usageBar');
                const characterCountElement = document.getElementById('characterCount');
                const resetDateElement = document.getElementById('resetDate');

                const usagePercentage = (characterCount / characterLimit) * 100;
                usageBar.style.width = `${usagePercentage}%`;

                document.getElementById('usagePercentage').textContent = `(${usagePercentage.toFixed(0)}%)`;

                if (usagePercentage >= 90) {
                    usageBar.classList.add('usage-danger');
                    usageBar.classList.remove('usage-warning');
                } else if (usagePercentage >= 80) {
                    usageBar.classList.add('usage-warning');
                    usageBar.classList.remove('usage-danger');
                } else {
                    usageBar.classList.remove('usage-danger', 'usage-warning');
                }

                const formattedCharCount = formatNumber(characterCount);
                const formattedCharLimit = formatNumber(characterLimit);
                characterCountElement.textContent = `${formattedCharCount} / ${formattedCharLimit}`;

                const resetDate = formatDate(nextReset * 1000);
                resetDateElement.textContent = `${resetDate}`;

                updateCharCount();
            }

            function clearUsageInfo() {
                updateUsageInfo(0, 0, 0);
                document.getElementById('voiceSelect').innerHTML = '';
            }

            document.getElementById('apiKeyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const apiKey = document.getElementById('apiKey').value.trim();
                if (apiKey) {
                    apiKeys = [apiKey];
                    localStorage.setItem('elevenLabsApiKeys', JSON.stringify(apiKeys));
                    currentApiKeyIndex = 0;
                    localStorage.setItem('currentApiKeyIndex', currentApiKeyIndex);
                    
                    updateApiKeyDisplay();
                    updateApiKeyNavigation();
                    fetchVoices();
                    fetchUsageInfo();
                    
                    document.getElementById('apiKey').value = '';
                    showCustomAlert('API Key saved successfully!', 'success');
                }
            });

            document.getElementById('ttsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const apiKey = apiKeys[currentApiKeyIndex] || localStorage.getItem('elevenLabsApiKey');
                if (!apiKey) {
                    showCustomAlert('Please configure your API key first!', 'error');
                    return;
                }
            
                const text = document.getElementById('inputText').value;
                const modelId = document.getElementById('modelSelect').value;
                const voiceId = document.getElementById('voiceSelect').value;
                const loading = document.getElementById('loading');
                const audioContainer = document.getElementById('audioContainer');
                const audioPlayer = document.getElementById('audioPlayer');
                const downloadButton = document.getElementById('downloadButton');
                const generateButton = this.querySelector('button[type="submit"]');
                const generateButtonText = generateButton.innerHTML;
                
                loading.classList.add('hidden');
                audioContainer.classList.add('hidden');
                downloadButton.classList.add('hidden');
                generateButton.disabled = true;
                generateButton.innerHTML = '<i class="fad fa-spinner-third fa-spin mr-2"></i> Processing<span class="dots"><merged_code>...</span>';
            
                try {
                    const response = await fetch(`/generate-audio?text=${encodeURIComponent(text)}&model_id=${encodeURIComponent(modelId)}&voice_id=${encodeURIComponent(voiceId)}`, {
                        headers: {
                            'X-API-KEY': apiKey
                        }
                    });
            
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
            
                    const audioBlob = await response.blob();
                    
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    
                    audioContainer.classList.remove('hidden');
                    downloadButton.classList.remove('hidden');
            
                    saveToHistory(text, audioBlob, modelId);
            
                    fetchUsageInfo();
            
                } catch (error) {
                    console.error('Error:', error);
                    showCustomAlert('Error generating audio. Please check your API key and try again.', 'error');
                } finally {
                    generateButton.disabled = false;
                    generateButton.innerHTML = generateButtonText;
                }
            });

            function animateDots() {
                const dots = document.querySelector('.dots');
                if (dots) {
                    let currentDots = dots.textContent;
                    dots.textContent = currentDots.length >= 3 ? '.' : currentDots + '.';
                    setTimeout(animateDots, 500);
                }
            }

            animateDots();

            function updateHistoryUI() {
                const historyContent = document.getElementById('historyContent');
                const historyItem = document.getElementById('historyItem');
                const historyNavigation = document.getElementById('historyNavigation');
                const historyCount = document.getElementById('historyCount');
                const noHistoryMessage = document.getElementById('noHistoryMessage');
                const clearAllHistoryButton = document.getElementById('clearAllHistory');
                const prevButton = document.getElementById('prevHistory');
                const nextButton = document.getElementById('nextHistory');
                const currentHistoryIndexInput = document.getElementById('currentHistoryIndex');
                const historyTimestamp = document.getElementById('historyTimestamp');
                const historyCharCount = document.getElementById('historyCharCount');
                const historyText = document.getElementById('historyText');
                const toggleFullText = document.getElementById('toggleFullText');
                const historyAudio = document.getElementById('historyAudio');
                const historyAudioSize = document.getElementById('historyAudioSize');


                if (historyItems.length > 0 && currentHistoryIndex >= 0) {
                    historyContent.classList.remove('hidden');
                    noHistoryMessage.classList.add('hidden');
                    historyItem.classList.remove('hidden');
                    historyNavigation.classList.remove('hidden');
                    historyCount.textContent = `(${historyItems.length})`;
                    clearAllHistoryButton.classList.remove('hidden');

                    const item = historyItems[currentHistoryIndex];
                    
                    historyTimestamp.innerHTML = `<i class="fas fa-calendar-clock mr-1"></i>${formatDate(item.timestamp)}`;
                    
                    historyCharCount.innerHTML = `<i class="fas fa-font mr-1"></i>${formatNumber(item.text.length)}`;
                    
                    const fullText = item.text;
                    const limitedText = fullText.length > 500 ? fullText.slice(0, 497) + '...' : fullText;
                    historyText.textContent = limitedText;
                    
                    if (fullText.length > 500) {
                        toggleFullText.classList.remove('hidden');
                        toggleFullText.textContent = 'Show More';
                        toggleFullText.onclick = function() {
                            if (historyText.textContent.length <= 500) {
                                historyText.textContent = fullText;
                                toggleFullText.textContent = 'Show Less';
                            } else {
                                historyText.textContent = limitedText;
                                toggleFullText.textContent = 'Show More';
                            }
                        };
                    } else {
                        toggleFullText.classList.add('hidden');
                    }
                    
                    historyAudio.src = URL.createObjectURL(item.audio);
                    
                    historyAudioSize.innerHTML = `
                        <span class="desktop-info">
                            <i class="fas fa-database mr-1"></i>${formatFileSize(item.audio.size)}
                            <i class="fas fa-microphone-lines ml-2 mr-1"></i>${getModelName(item.modelId)}
                            <i class="fas fa-user-headset ml-2 mr-1"></i>${item.voiceName}
                        </span>
                        <span class="mobile-info">
                            <i class="fas fa-database mr-1"></i>${formatFileSize(item.audio.size)}<br>
                            <i class="fas fa-microphone-lines mr-1"></i>${getModelName(item.modelId)}<br>
                            <i class="fas fa-user-headset mr-1"></i>${item.voiceName}
                        </span>`;

                    currentHistoryIndexInput.value = currentHistoryIndex + 1;

                    prevButton.classList.toggle('opacity-50', currentHistoryIndex <= 0);
                    nextButton.classList.toggle('opacity-50', currentHistoryIndex >= historyItems.length - 1);
                } else {
                    historyContent.classList.add('hidden');
                    noHistoryMessage.classList.remove('hidden');
                    historyItem.classList.add('hidden');
                    historyNavigation.classList.add('hidden');
                    historyCount.textContent = '';
                    clearAllHistoryButton.classList.add('hidden');
                    prevButton.classList.add('opacity-50');
                    nextButton.classList.add('opacity-50');
                    currentHistoryIndexInput.value = '';
                }
            }

            function loadHistoryFromDB() {
                const transaction = db.transaction([storeName], "readonly");
                const objectStore = transaction.objectStore(storeName);
                const index = objectStore.index("timestamp");
                const request = index.openCursor(null, "prev");

                historyItems = [];

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        historyItems.push(cursor.value);
                        cursor.continue();
                    } else {
                        currentHistoryIndex = historyItems.length > 0 ? 0 : -1;
                        updateHistoryUI();
                    }
                };

                request.onerror = function(event) {
                    console.error("Error loading history from the database:", event.target.error);
                };
            }

            document.getElementById('audioPlayer').addEventListener('error', function(e) {
                console.error('Audio playback error:',e);
                showCustomAlert('Error playing audio. Please try again.', 'error');
            });

            document.getElementById('downloadButton').addEventListener('click', function() {
                const audioPlayer = document.getElementById('audioPlayer');
                if (!audioPlayer.src) {
                    showCustomAlert('No audio available to download', 'error');
                    return;
                }
                fetch(audioPlayer.src)
                    .then(response => response.blob())
                    .then(blob => {
                        const modelId = document.getElementById('modelSelect').value;
                        const voiceSelect = document.getElementById('voiceSelect');
                        const voiceName = voiceSelect.options[voiceSelect.selectedIndex].text.split(' (')[0];
                        const date = new Date();
                        const formattedDate = formatDate(date, true).replace(/[/:]/g, '').replace(' ', '_');
                        const fileName = `ElevenLabsFree_${getModelName(modelId)}_${voiceName}_${formattedDate}.mp3`;
                        downloadAudio(blob, fileName);
                    });
            });

            function formatDate(date, includeTime = true) {
                const options = {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                };
                if (includeTime) {
                    Object.assign(options, {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
                return new Date(date).toLocaleString('en-GB', options).replace(/\//g, '/').replace(',', '');
            }

            document.getElementById('prevHistory').addEventListener('click', function() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    updateHistoryUI();
                }
            });

            document.getElementById('nextHistory').addEventListener('click', function() {
                if (currentHistoryIndex < historyItems.length - 1) {
                    currentHistoryIndex++;
                    updateHistoryUI();
                }
            });

            document.getElementById('copyTextButton').addEventListener('click', function() {
                const copyButton = document.getElementById('copyTextButton');
                const originalIcon = copyButton.innerHTML;
                
                if (currentHistoryIndex >= 0 && currentHistoryIndex < historyItems.length) {
                    const text = historyItems[currentHistoryIndex].text;
                    navigator.clipboard.writeText(text).then(function() {
                        copyButton.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyButton.innerHTML = originalIcon;
                        }, 1000);
                    });
                }
            });

            document.getElementById('downloadHistoryAudio').addEventListener('click', function() {
                if (currentHistoryIndex >= 0 && currentHistoryIndex < historyItems.length) {
                    const item = historyItems[currentHistoryIndex];
                    const date = new Date(item.timestamp);
                    const formattedDate = formatDate(item.timestamp, true).replace(/[/:]/g, '').replace(' ', '_');
                    const fileName = `ElevenLabsFree_${getModelName(item.modelId)}_${item.voiceName}_${formattedDate}.mp3`;
                    downloadAudio(item.audio, fileName);
                }
            });

            document.getElementById('reuseTextButton').addEventListener('click', function() {
                if (currentHistoryIndex >= 0 && currentHistoryIndex < historyItems.length) {
                    const text = historyItems[currentHistoryIndex].text;
                    document.getElementById('inputText').value = text;
                    updateCharCount();
                    document.querySelector('[data-tab="dashboard"]').click();
                }
            });

            document.getElementById('currentHistoryIndex').addEventListener('change', function() {
                let newIndex = parseInt(this.value) - 1;
                if (!isNaN(newIndex) && newIndex >= 0 && newIndex < historyItems.length) {
                    currentHistoryIndex = newIndex;
                    updateHistoryUI();
                } else {
                    this.value = currentHistoryIndex + 1;
                }
            });

            function deleteHistoryItem(id) {
                const transaction = db.transaction([storeName], "readwrite");
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.delete(id);

                request.onsuccess = function(event) {
                    console.log("History item deleted from the database.");
                    loadHistoryFromDB();
                };

                request.onerror = function(event) {
                    console.error("Error deleting history item from the database:", event.target.error);
                };
            }

            document.getElementById('deleteHistoryButton').addEventListener('click', function() {
                if (currentHistoryIndex >= 0 && currentHistoryIndex < historyItems.length) {
                    showCustomConfirm("Are you sure you want to delete this history item?", function() {
                        deleteHistoryItem(historyItems[currentHistoryIndex].id);
                        showCustomAlert('History item has been deleted.', 'info');
                    });
                }
            });

            document.getElementById('clearAllHistory').addEventListener('click', function() {
                showCustomConfirm("Are you sure you want to delete all history items?", function() {
                    const transaction = db.transaction([storeName], "readwrite");
                    const objectStore = transaction.objectStore(storeName);
                    const request = objectStore.clear();

                    request.onsuccess = function(event) {
                        console.log("All history items deleted from the database.");
                        loadHistoryFromDB();
                        showCustomAlert('All history items have been deleted.', 'info');
                    };

                    request.onerror = function(event) {
                        console.error("Error deleting all history items from the database:", event.target.error);
                        showCustomAlert('Error deleting history items. Please try again.', 'error');
                    };
                });
            });


            function getModelName(modelId) {
                const models = {
                    'eleven_multilingual_v2': 'Eleven Multilingual v2',
                    'eleven_flash_v2_5': 'Eleven Flash v2.5',
                    'eleven_turbo_v2_5': 'Eleven Turbo v2.5',
                    'eleven_turbo_v2': 'Eleven Turbo v2',
                    'eleven_flash_v2': 'Eleven Flash v2'
                };
                return models[modelId] || modelId;
            }

            document.getElementById('modelSelect').addEventListener('change', function() {
                localStorage.setItem('elevenLabsSelectedModel', this.value);
            });

            function saveSelectedVoice() {
                const voiceSelect = document.getElementById('voiceSelect');
                localStorage.setItem('elevenLabsSelectedVoice', voiceSelect.value);
            }

            function populateVoiceSelect(voices) {
                const voiceSelect = document.getElementById('voiceSelect');
                const savedVoice = localStorage.getItem('elevenLabsSelectedVoice');
                voiceSelect.innerHTML = '';
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    
                    let language = voice.language === 'id' ? 'Indonesian' : '';
                    
                    const labels = [
                        language,
                        voice.labels.gender,
                        voice.labels.age,
                        voice.labels.accent,
                        voice.labels.description,
                        voice.labels.use_case
                    ].filter(Boolean);

                    const labelText = labels.join(', ');
                    
                    const voiceName = voice.name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    const formattedLabelText = labelText.split(', ').map(label => {
                        return label.split(/[-_\s]/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }).join(', ');
                    
                    option.textContent = `${voiceName} (${formattedLabelText})`;
                    option.title = `${voiceName}\nLanguage: ${language || 'en'}\n${formattedLabelText}`;
                    voiceSelect.appendChild(option);

                    if (voice.id === savedVoice) {
                        option.selected = true;
                    }
                });

                voiceSelect.addEventListener('change', saveSelectedVoice);
            }

            function saveToHistory(text, audioBlob, modelId) {
                const transaction = db.transaction([storeName], "readwrite");
                const objectStore = transaction.objectStore(storeName);
                const voiceSelect = document.getElementById('voiceSelect');
                const voiceName = voiceSelect.options[voiceSelect.selectedIndex].text.split(' (')[0];
                const request = objectStore.add({
                    text: text,
                    audio: audioBlob,
                    modelId: modelId,
                    voiceName: voiceName,
                    timestamp: new Date().getTime()
                });

                request.onsuccess = function(event) {
                    console.log("History item added to the database.");
                    loadHistoryFromDB();
                };

                request.onerror = function(event) {
                    console.error("Error adding history item to the database:", event.target.error);
                };
            }

            function showCustomAlert(message, type = 'info') {
                const alertElement = document.getElementById('customAlert');
                const overlayElement = document.getElementById('customAlertOverlay');
                alertElement.innerHTML = `<div>${message}</div>`;
                alertElement.classList.remove('hidden', 'custom-alert-success', 'custom-alert-error', 'custom-alert-info');
                alertElement.classList.add(`custom-alert-${type}`, 'show');
                overlayElement.style.display = 'block';
    
                setTimeout(() => {
                    alertElement.classList.remove('show');
                    overlayElement.style.display = 'none';
                    setTimeout(() => {
                        alertElement.classList.add('hidden');
                    }, 200);
                }, 2000);
            }

            function showCustomConfirm(message, onConfirm, onCancel) {
                const alertElement = document.getElementById('customAlert');
                const overlayElement = document.getElementById('customAlertOverlay');
                alertElement.innerHTML = `
                    <div class="custom-alert-message">${message}</div>
                    <div class="custom-alert-buttons">
                        <button class="custom-alert-button custom-alert-cancel">Cancel</button>
                        <button class="custom-alert-button custom-alert-confirm">Confirm</button>
                    </div>
                `;
                alertElement.classList.remove('hidden');
                alertElement.classList.add('show');
                overlayElement.style.display = 'block';

                const confirmButton = alertElement.querySelector('.custom-alert-confirm');
                const cancelButton = alertElement.querySelector('.custom-alert-cancel');

                confirmButton.addEventListener('click', () => {
                    alertElement.classList.remove('show');
                    overlayElement.style.display = 'none';
                    setTimeout(() => {
                        alertElement.classList.add('hidden');
                        onConfirm();
                    }, 200);
                });

                cancelButton.addEventListener('click', () => {
                    alertElement.classList.remove('show');
                    overlayElement.style.display = 'none';
                    setTimeout(() => {
                        alertElement.classList.add('hidden');
                        if (onCancel) onCancel();
                    }, 200);
                });
            }

            document.getElementById('prevApiKey').addEventListener('click', function() {
                if (currentApiKeyIndex > 0) {
                    currentApiKeyIndex--;
                    updateApiKeyDisplay();
                    updateApiKeyNavigation();
                    fetchVoices();
                    fetchUsageInfo();
                }
            });

            document.getElementById('nextApiKey').addEventListener('click', function() {
                if (currentApiKeyIndex < apiKeys.length - 1) {
                    currentApiKeyIndex++;
                    updateApiKeyDisplay();
                    updateApiKeyNavigation();
                    fetchVoices();
                    fetchUsageInfo();
                }
            });

            document.getElementById('currentApiKeyIndex').addEventListener('change', function() {
                let newIndex = parseInt(this.value) - 1;
                if (!isNaN(newIndex) && newIndex >= 0 && newIndex < apiKeys.length) {
                    currentApiKeyIndex = newIndex;
                    updateApiKeyDisplay();
                    updateApiKeyNavigation();
                    fetchVoices();
                    fetchUsageInfo();
                } else {
                    this.value = currentApiKeyIndex + 1;
                }
            });
        });
    </script>
</body>
</html>